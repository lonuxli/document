# å†…å­˜ç®¡ç†ä¹‹CMA

**ä¸€ã€ä»€ä¹ˆæ˜¯CMA**

CMAï¼ŒContiguous Memory Allocatorï¼Œæ˜¯å†…å­˜ç®¡ç†å­ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œè´Ÿè´£ç‰©ç†åœ°å€è¿ç»­çš„å†…å­˜åˆ†é…ã€‚ä¸€èˆ¬ç³»ç»Ÿä¼šåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä»æ•´ä¸ªmemoryä¸­é…ç½®ä¸€æ®µè¿ç»­å†…å­˜ç”¨äºCMAï¼Œç„¶åå†…æ ¸å…¶ä»–çš„æ¨¡å—å¯ä»¥é€šè¿‡CMAçš„æ¥å£APIè¿›è¡Œè¿ç»­å†…å­˜çš„åˆ†é…ã€‚CMAçš„æ ¸å¿ƒå¹¶ä¸æ˜¯è®¾è®¡ç²¾å·§çš„ç®—æ³•æ¥ç®¡ç†åœ°å€è¿ç»­çš„å†…å­˜å—ï¼Œå®é™…ä¸Šå®ƒçš„åº•å±‚è¿˜æ˜¯ä¾èµ–å†…æ ¸ä¼™ä¼´ç³»ç»Ÿè¿™æ ·çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæˆ–è€…è¯´CMAæ˜¯å¤„äºéœ€è¦è¿ç»­å†…å­˜å—çš„å…¶ä»–å†…æ ¸æ¨¡å—ï¼ˆä¾‹å¦‚DMA mapping frameworkï¼‰å’Œå†…å­˜ç®¡ç†æ¨¡å—ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´å±‚æ¨¡å—ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

1ã€è§£æDTSæˆ–è€…å‘½ä»¤è¡Œä¸­çš„å‚æ•°ï¼Œç¡®å®šCMAå†…å­˜çš„åŒºåŸŸï¼Œè¿™æ ·çš„åŒºåŸŸæˆ‘ä»¬å®šä¹‰ä¸ºCMA areaã€‚

2ã€æä¾›cma\_allocå’Œcma\_releaseä¸¤ä¸ªæ¥å£å‡½æ•°ç”¨äºåˆ†é…å’Œé‡Šæ”¾CMA pages

3ã€è®°å½•å’Œè·Ÿè¸ªCMA areaä¸­å„ä¸ªpagesçš„çŠ¶æ€

4ã€è°ƒç”¨ä¼™ä¼´ç³»ç»Ÿæ¥å£ï¼Œè¿›è¡ŒçœŸæ­£çš„å†…å­˜åˆ†é…ã€‚

Â 

**äºŒã€å†…æ ¸ä¸­ä¸ºä½•å»ºç«‹CMAæ¨¡å—ï¼Ÿ**

Linuxå†…æ ¸ä¸­å·²ç»æä¾›äº†å„ç§å†…å­˜åˆ†é…çš„æ¥å£ï¼Œä¸ºä½•è¿˜æœ‰å»ºç«‹CMAè¿™ç§è¿ç»­å†…å­˜åˆ†é…çš„æœºåˆ¶å‘¢ï¼Ÿ

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å†…æ ¸å“ªäº›æ¨¡å—æœ‰ç‰©ç†åœ°å€è¿ç»­çš„éœ€æ±‚ã€‚huge pageæ¨¡å—éœ€è¦ç‰©ç†åœ°å€è¿ç»­æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚å¤§å®¶éƒ½ç†Ÿæ‚‰çš„å¤„ç†å™¨ï¼ˆä¸è¦å¤ªå¤è€ï¼‰ï¼Œä¾‹å¦‚ARM64ï¼Œå…¶å†…å­˜ç®¡ç†å•å…ƒéƒ½å¯ä»¥æ”¯æŒå¤šä¸ªé¡µé¢å¤§å°ï¼ˆ4kã€64Kã€2Mæˆ–è€…æ›´å¤§çš„page sizeï¼‰ï¼Œä½†åœ¨å¤§å¤šæ•°CPUæ¶æ„ä¸Šï¼ŒLinuxå†…æ ¸æ€»æ˜¯å€¾å‘ä½¿ç”¨æœ€å°çš„page sizeï¼Œå³4K page sizeã€‚Page sizeå¤§äº4Kçš„pageç»Ÿç§°ä¸ºâ€œhuge pageâ€ã€‚å¯¹äºä¸€ä¸ª2Mçš„huge pageï¼ŒMMUä¼šæŠŠä¸€ä¸ªè¿ç»­çš„2Mçš„è™šæ‹Ÿåœ°å€mappingåˆ°è¿ç»­çš„ã€2Mçš„ç‰©ç†åœ°å€ä¸Šå»ï¼Œå½“ç„¶ï¼Œè¿™2M sizeçš„ç‰©ç†åœ°å€æ®µå¿…é¡»æ˜¯ç”±512ä¸ªåœ°å€è¿ç»­çš„4k page frameç»„æˆã€‚

å½“ç„¶ï¼Œæ›´å¤šçš„è¿ç»­å†…å­˜çš„åˆ†é…éœ€æ±‚æ¥è‡ªå½¢å½¢è‰²è‰²çš„é©±åŠ¨ã€‚ä¾‹å¦‚ç°åœ¨å¤§å®¶çš„æ‰‹æœºéƒ½æœ‰è§†é¢‘åŠŸèƒ½ï¼ŒcameråŠŸèƒ½ï¼Œè¿™ç±»é©±åŠ¨éƒ½éœ€è¦éå¸¸å¤§å—çš„å†…å­˜ï¼Œè€Œä¸”æœ‰DMAç”¨æ¥è¿›è¡Œå¤–è®¾å’Œå¤§å—å†…å­˜ä¹‹é—´çš„æ•°æ®äº¤æ¢ã€‚å¯¹äºåµŒå…¥å¼è®¾å¤‡ï¼Œä¸€èˆ¬ä¸ä¼šæœ‰IOMMUï¼Œè€Œä¸”DMAä¹Ÿä¸å…·å¤‡scatter\-getteråŠŸèƒ½ï¼Œè¿™æ—¶å€™ï¼Œé©±åŠ¨åˆ†é…çš„å¤§å—å†…å­˜ï¼ˆDMA bufferï¼‰å¿…é¡»æ˜¯ç‰©ç†åœ°å€è¿ç»­çš„ã€‚

é¡ºä¾¿è¯´ä¸€å¥ï¼Œhuge pageçš„è¿ç»­å†…å­˜éœ€æ±‚å’Œé©±åŠ¨DMA bufferè¿˜æ˜¯æœ‰ä¸åŒçš„ï¼Œä¾‹å¦‚åœ¨å¯¹é½è¦æ±‚ä¸Šï¼Œä¸€ä¸ª2Mçš„huge pageï¼Œå…¶åº•å±‚çš„2M çš„ç‰©ç†é¡µé¢çš„é¦–åœ°å€éœ€è¦å¯¹é½åœ¨2Mä¸Šï¼Œä¸€èˆ¬è€Œè¨€ï¼ŒDMA bufferä¸ä¼šæœ‰è¿™ä¹ˆé«˜çš„å¯¹é½è¦æ±‚ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿™é‡Œè®²çš„CMAä¸»è¦æ˜¯ä¸ºè®¾å¤‡é©±åŠ¨å‡†å¤‡çš„ï¼Œhuge pageç›¸å…³çš„å†…å®¹ä¸åœ¨æœ¬æ–‡ä¸­æè¿°ã€‚

æˆ‘ä»¬æ¥ä¸€ä¸ªå®é™…çš„ä¾‹å­å§ï¼šæˆ‘çš„æ‰‹æœºï¼Œåƒç´ æ˜¯1300Wçš„ï¼Œä¸€ä¸ªåƒç´ éœ€è¦3Bï¼Œé‚£ä¹ˆæ‹æ‘„ä¸€å¹…å›¾ç‰‡éœ€è¦çš„å†…å­˜å¤§æ¦‚æ˜¯1300W x 3B ï¼ 26MBã€‚é€šè¿‡å†…å­˜ç®¡ç†ç³»ç»Ÿåˆ†é…26Mçš„å†…å­˜ï¼Œå‹åŠ›å¯æ˜¯ä¸å°ã€‚å½“ç„¶ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨ä¹‹å¤„ï¼Œä¼™ä¼´ç³»ç»Ÿä¸­çš„å¤§å—å†…å­˜æ¯”è¾ƒå¤§ï¼Œä¹Ÿè®¸åˆ†é…26Mä¸ç®—ä»€ä¹ˆï¼Œä½†æ˜¯éšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œå†…å­˜ä¸æ–­çš„åˆ†é…ã€é‡Šæ”¾ï¼Œå¤§å—å†…å­˜ä¸æ–­çš„è£‚è§£ï¼Œå†è£‚è§£ï¼Œè¿™æ—¶å€™ï¼Œå†…å­˜ç¢ç‰‡åŒ–å¯¼è‡´åˆ†é…åœ°å€è¿ç»­çš„å¤§å—å†…å­˜å˜å¾—ä¸æ˜¯é‚£ä¹ˆçš„å®¹æ˜“äº†ï¼Œæ€ä¹ˆåŠï¼Ÿä½œä¸ºé©±åŠ¨å·¥ç¨‹å¸ˆï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼šå…¶ä¸€æ˜¯åœ¨å¯åŠ¨æ—¶åˆ†é…ç”¨äºè§†é¢‘é‡‡é›†çš„DMA bufferï¼Œå¦å¤–ä¸€ä¸ªæ–¹æ¡ˆæ˜¯å½“å®é™…ä½¿ç”¨camerè®¾å¤‡çš„æ—¶å€™åˆ†é…DMA bufferã€‚å‰è€…çš„é€‰æ‹©æ˜¯å¯é çš„ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå³å½“ç…§ç›¸æœºä¸ä½¿ç”¨æ—¶ï¼ˆå¤§å¤šæ•°æ—¶é—´å†…cameraå…¶å®éƒ½æ˜¯ç©ºé—²çš„ï¼‰ï¼Œé¢„ç•™çš„é‚£äº›DMA BUFFERçš„å†…å­˜å®é™…ä¸Šæ˜¯æµªè´¹äº†ï¼ˆç‰¹åˆ«åœ¨å†…å­˜é…ç½®ä¸å¤§çš„ç³»ç»Ÿä¸Šæ›´æ˜¯å¦‚æ­¤ï¼‰ã€‚åä¸€ç§é€‰æ‹©ä¸ä¼šæµªè´¹å†…å­˜ï¼Œä½†æ˜¯ä¸å¯é ï¼Œéšç€å†…å­˜ç¢ç‰‡åŒ–ï¼Œå¤§çš„ã€è¿ç»­çš„å†…å­˜åˆ†é…å˜å¾—è¶Šæ¥è¶Šå›°éš¾ï¼Œä¸€æ—¦å†…å­˜åˆ†é…å¤±è´¥ï¼ŒcameraåŠŸèƒ½å°±ä¼šç¼ºå¤±ï¼Œä¼°è®¡ç”¨æˆ·ä¸ä¼šç­”åº”ã€‚

è¿™å°±æ˜¯é©±åŠ¨å·¥ç¨‹å¸ˆé¢ä¸´çš„å›°å¢ƒï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå„ä¸ªé©±åŠ¨å„å‡ºå¥‡æ‹›ï¼Œä½†æ˜¯éƒ½ä¸èƒ½éå¸¸å®Œç¾çš„è§£å†³é—®é¢˜ã€‚æœ€ç»ˆæ¥è‡ªMichal Nazarewiczçš„CMAè¡¥ä¸å°†å¯ä»¥æŠŠå„ä¸ªé©±åŠ¨å·¥ç¨‹å¸ˆçš„çƒ¦æ¼â€œä¸€æ´—äº†ä¹‹â€ã€‚å¯¹äºCMA å†…å­˜ï¼Œå½“å‰é©±åŠ¨æ²¡æœ‰åˆ†é…ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿™äº›memoryå¯ä»¥å†…æ ¸çš„è¢«å…¶ä»–çš„æ¨¡å—ä½¿ç”¨ï¼ˆå½“ç„¶æœ‰ä¸€å®šçš„è¦æ±‚ï¼‰ï¼Œè€Œå½“é©±åŠ¨åˆ†é…CMAå†…å­˜åï¼Œé‚£äº›è¢«å…¶ä»–æ¨¡å—ä½¿ç”¨çš„å†…å­˜éœ€è¦åå‡ºæ¥ï¼Œå½¢æˆç‰©ç†åœ°å€è¿ç»­çš„å¤§å—å†…å­˜ï¼Œç»™å…·ä½“çš„é©±åŠ¨æ¥ä½¿ç”¨ã€‚

Â 

**ä¸‰ã€CMAæ¨¡å—çš„è“å›¾æ˜¯æ€æ ·çš„ï¼Ÿ**

Â [![](http://www.wowotech.net/content/uploadfile/201706/9602cb5181db7f560dfd5702c957c18220170628102932.gif)](http://www.wowotech.net/content/uploadfile/201706/06d4c31f4030a8e984474d34258f4eab20170628102931.gif)

äº†è§£ä¸€ä¸ªæ¨¡å—ï¼Œå…ˆä¸è¦æ·±å…¥ç»†èŠ‚ï¼Œæˆ‘ä»¬å…ˆè¿œè¿œçš„çœ‹çœ‹CMAåœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„ä½ç½®ã€‚è™½ç„¶ç”¨äºè§£å†³é©±åŠ¨çš„å†…å­˜åˆ†é…é—®é¢˜ï¼Œä½†æ˜¯é©±åŠ¨å¹¶ä¸ä¼šç›´æ¥è°ƒç”¨CMAæ¨¡å—çš„æ¥å£ï¼Œè€Œæ˜¯é€šè¿‡DMA mapping frameworkæ¥é—´æ¥ä½¿ç”¨CMAçš„æœåŠ¡ã€‚ä¸€å¼€å§‹ï¼ŒCMA areaçš„æ¦‚å¿µæ˜¯å…¨å±€çš„ï¼Œé€šè¿‡å†…æ ¸é…ç½®å‚æ•°å’Œå‘½ä»¤è¡Œå‚æ•°ï¼Œå†…æ ¸å¯ä»¥å®šä½åˆ°Global CMA areaåœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€å’Œå¤§å°ï¼ˆæ³¨ï¼šè¿™é‡Œçš„Globalçš„æ„æ€æ˜¯é’ˆå¯¹æ‰€æœ‰çš„driverè€Œè¨€çš„ï¼‰ã€‚å¹¶åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨dma\_contiguous\_reserveå‡½æ•°ï¼Œå°†æŒ‡å®šçš„memory regionä¿ç•™ç»™Global CMA areaä½¿ç”¨ã€‚äººæ€§æ˜¯è´ªå©ªçš„ï¼Œé©±åŠ¨äº¦ç„¶ï¼Œå¾ˆå¿«ï¼Œæœ‰äº›é©±åŠ¨æƒ³åƒç‹¬é£Ÿï¼Œä¸æ„¿æ„å’Œå…¶ä»–é©±åŠ¨å…±äº«CMAï¼Œå› æ­¤å‡ºç°ä¸¤ç§CMA areaï¼šGlobal CMA areaç»™å¤§å®¶å…±äº«ï¼Œè€Œper device CMAå¯ä»¥ç»™æŒ‡å®šçš„ä¸€ä¸ªæˆ–è€…å‡ ä¸ªé©±åŠ¨ä½¿ç”¨ã€‚è¿™æ—¶å€™ï¼Œå‘½ä»¤è¡Œå‚æ•°ä¸æ˜¯é‚£ä¹ˆåˆé€‚äº†ï¼Œå› æ­¤å¼•å…¥äº†device treeä¸­çš„reserved memory nodeçš„æ¦‚å¿µã€‚å½“ç„¶ï¼Œä¸ºäº†å…¼å®¹ï¼Œå†…æ ¸ä»ç„¶æ”¯æŒCMAçš„command lineå‚æ•°ã€‚

Â 

**å››ã€CMAæ¨¡å—å¦‚ä½•ç®¡ç†å’Œé…ç½®CMA areaï¼Ÿ**

åœ¨CMAæ¨¡å—ä¸­ï¼Œstruct cmaæ•°æ®ç»“æ„ç”¨æ¥æŠ½è±¡ä¸€ä¸ªCMA areaï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š

> struct cma {
> 
> unsigned longÂ Â  base\_pfn;
> 
> unsigned longÂ Â  count;Â  //pageæ•°é‡
> 
> unsigned longÂ Â  \*bitmap;
> 
> unsigned int order\_per\_bit; /\* Order of pages represented by one bit \*/
> 
> struct mutexÂ Â Â  lock;
> 
> };

cmaæ¨¡å—ä½¿ç”¨bitmapæ¥ç®¡ç†å…¶å†…å­˜çš„åˆ†é…ï¼Œ0è¡¨ç¤ºfreeï¼Œ1è¡¨ç¤ºå·²ç»åˆ†é…ã€‚å…·ä½“å†…å­˜ç®¡ç†çš„å•ä½å’Œstruct cmaä¸­çš„order\_per\_bitæˆå‘˜ç›¸å…³ï¼Œå¦‚æœorder\_per\_bitç­‰äº0ï¼Œè¡¨ç¤ºæŒ‰ç…§ä¸€ä¸ªä¸€ä¸ªpageæ¥åˆ†é…å’Œé‡Šæ”¾ï¼Œå¦‚æœorder\_per\_bitç­‰äº1ï¼Œè¡¨ç¤ºæŒ‰ç…§2ä¸ªpageç»„æˆçš„blockæ¥åˆ†é…å’Œé‡Šæ”¾ï¼Œä»¥æ­¤ç±»æ¨ã€‚struct cmaä¸­çš„bitmapæˆå‘˜å°±æ˜¯ç®¡ç†è¯¥cma areaå†…å­˜çš„bit mapã€‚countæˆå‘˜è¯´æ˜äº†è¯¥cma areaå†…å­˜æœ‰å¤šå°‘ä¸ªpageã€‚å®ƒå’Œorder\_per\_bitä¸€èµ·å†³å®šäº†bitmapæŒ‡é’ˆæŒ‡å‘å†…å­˜çš„å¤§å°ã€‚base\_pfnå®šä¹‰äº†è¯¥CMA areaçš„èµ·å§‹page frame numberï¼Œbase\_pfnå’Œcountä¸€èµ·å®šä¹‰äº†è¯¥CMA areaåœ¨å†…å­˜åœ¨çš„ä½ç½®ã€‚

æˆ‘ä»¬å‰é¢è¯´è¿‡äº†ï¼ŒCMAæ¨¡å—éœ€è¦ç®¡ç†è‹¥å¹²ä¸ªCMA areaï¼Œæœ‰gloalçš„ï¼Œæœ‰per deviceçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š

> struct cma cma\_areas\[MAX\_CMA\_AREAS\];

æ¯ä¸€ä¸ªstruct cmaæŠ½è±¡äº†ä¸€ä¸ªCMA areaï¼Œæ ‡è¯†äº†ä¸€ä¸ªç‰©ç†åœ°å€è¿ç»­çš„memory areaã€‚è°ƒç”¨cma\_allocåˆ†é…çš„è¿ç»­å†…å­˜å°±æ˜¯ä»CMA areaä¸­è·å¾—çš„ã€‚å…·ä½“æœ‰å¤šå°‘ä¸ªCMA areaæ˜¯ç¼–è¯‘æ—¶å†³å®šäº†ï¼Œè€Œå…·ä½“è¦é…ç½®å¤šå°‘ä¸ªCMA areaæ˜¯å’Œç³»ç»Ÿè®¾è®¡ç›¸å…³ï¼Œä½ å¯ä»¥ä¸ºç‰¹å®šçš„é©±åŠ¨å‡†å¤‡ä¸€ä¸ªCMA areaï¼Œä¹Ÿå¯ä»¥åªå»ºç«‹ä¸€ä¸ªé€šç”¨çš„CMA areaï¼Œä¾›å¤šä¸ªé©±åŠ¨ä½¿ç”¨ï¼ˆæœ¬æ–‡é‡ç‚¹æè¿°è¿™ä¸ªå…±ç”¨çš„CMA areaï¼‰ã€‚

æˆ¿å­å»ºå¥½äº†ï¼Œä½†æ˜¯è¿˜ç©ºç€ï¼Œè¦æƒ³é‡‘å±‹è—å¨‡ï¼Œè¿˜éœ€è¦ä¸€ä¸ªCMAé…ç½®è¿‡ç¨‹ã€‚é…ç½®CMAå†…å­˜åŒºæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯é€šè¿‡dtsçš„reserved memoryï¼Œå¦å¤–ä¸€ç§æ˜¯é€šè¿‡command lineå‚æ•°å’Œå†…æ ¸é…ç½®å‚æ•°ã€‚

device treeä¸­å¯ä»¥åŒ…å«reserved\-memory nodeï¼Œåœ¨è¯¥èŠ‚ç‚¹çš„child nodeä¸­ï¼Œå¯ä»¥å®šä¹‰å„ç§ä¿ç•™å†…å­˜çš„ä¿¡æ¯ã€‚compatibleå±æ€§æ˜¯shared\-dma\-poolçš„é‚£ä¸ªèŠ‚ç‚¹æ˜¯ä¸“é—¨ç”¨äºå»ºç«‹ global CMA areaçš„ï¼Œè€Œå…¶ä»–çš„child nodeéƒ½æ˜¯for per device CMA areaçš„ã€‚

Global CMA areaçš„åˆå§‹åŒ–å¯ä»¥å‚è€ƒå®šä¹‰å¦‚ä¸‹ï¼š

> RESERVEDMEM\_OF\_DECLARE\(cma, "shared\-dma\-pool", rmem\_cma\_setup\);

å…·ä½“çš„setupè¿‡ç¨‹å€’æ˜¯æ¯”è¾ƒç®€å•ï¼Œä»device treeä¸­å¯ä»¥è·å–è¯¥memory rangeçš„èµ·å§‹åœ°å€å’Œå¤§å°ï¼Œè°ƒç”¨cma\_init\_reserved\_memå‡½æ•°å³å¯ä»¥æ³¨å†Œä¸€ä¸ªCMA areaã€‚éœ€è¦è¡¥å……è¯´æ˜çš„æ˜¯ï¼šCMAå¯¹åº”çš„reserved memoryèŠ‚ç‚¹å¿…é¡»æœ‰reusableå±æ€§ï¼Œä¸èƒ½æœ‰no\-mapçš„å±æ€§ã€‚å…·ä½“reusableå±æ€§çš„reserved memoryæœ‰è¿™æ ·çš„ç‰¹æ€§ï¼Œå³åœ¨é©±åŠ¨ä¸ä½¿ç”¨è¿™äº›å†…å­˜çš„æ—¶å€™ï¼ŒOSå¯ä»¥ä½¿ç”¨è¿™äº›å†…å­˜ï¼ˆå½“ç„¶æœ‰é™åˆ¶æ¡ä»¶ï¼‰ï¼Œè€Œå½“é©±åŠ¨ä»è¿™ä¸ªCMA areaåˆ†é…memoryçš„æ—¶å€™ï¼ŒOSå¯ä»¥reclaimè¿™äº›å†…å­˜ï¼Œè®©é©±åŠ¨å¯ä»¥ä½¿ç”¨å®ƒã€‚no\-mapå±æ€§å’Œåœ°å€æ˜ å°„ç›¸å…³ï¼Œå¦‚æœæ²¡æœ‰no\-mapå±æ€§ï¼Œé‚£ä¹ˆOSä¼šä¸ºè¿™æ®µmemoryåˆ›å»ºåœ°å€æ˜ å°„ï¼Œè±¡å…¶ä»–æ™®é€šå†…å­˜ä¸€æ ·ã€‚ä½†æ˜¯æœ‰no\-mapå±æ€§çš„å¾€å¾€æ˜¯ä¸“ç”¨äºæŸä¸ªè®¾å¤‡é©±åŠ¨ï¼Œåœ¨é©±åŠ¨ä¸­ä¼šè¿›è¡Œio remapï¼Œå¦‚æœOSå·²ç»å¯¹è¿™æ®µåœ°å€è¿›è¡Œäº†mappingï¼Œè€Œé©±åŠ¨åˆä¸€æ¬¡mappingï¼Œè¿™æ ·å°±æœ‰ä¸åŒçš„è™šæ‹Ÿåœ°å€mappingåˆ°åŒä¸€ä¸ªç‰©ç†åœ°å€ä¸Šå»ï¼Œåœ¨æŸäº›ARCHä¸Šï¼ˆARMv6ä¹‹åçš„cpuï¼‰ï¼Œä¼šé€ æˆä¸å¯é¢„çŸ¥çš„åæœã€‚è€ŒCMAè¿™ä¸ªåœºæ™¯ï¼Œreserved memoryå¿…é¡»è¦mappingå¥½ï¼Œè¿™æ ·æ‰èƒ½ç”¨äºå…¶ä»–å†…å­˜åˆ†é…åœºæ™¯ï¼Œä¾‹å¦‚page cacheã€‚

per device CMA areaçš„æ³¨å†Œè¿‡ç¨‹å’Œå„è‡ªå…·ä½“çš„é©±åŠ¨ç›¸å…³ï¼Œä½†æ˜¯æœ€ç»ˆä¼šdma\_declare\_contiguousè¿™ä¸ªæ¥å£å‡½æ•°ï¼Œä¸ºä¸€ä¸ªæŒ‡å®šçš„è®¾å¤‡è€Œæ³¨å†ŒCMA areaï¼Œè¿™é‡Œå°±ä¸è¯¦è¿°äº†ã€‚

é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¹Ÿå¯ä»¥å»ºç«‹cma areaã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡cma=nn\[MG\]@\[start\[MG\]\[\-end\[MG\]\]\]è¿™æ ·å‘½ä»¤è¡Œå‚æ•°æ¥æŒ‡æ˜Global CMA areaåœ¨æ•´ä¸ªç‰©ç†å†…å­˜ä¸­çš„ä½ç½®ã€‚åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå†…æ ¸ä¼šè§£æè¿™äº›å‘½ä»¤è¡Œå‚æ•°ï¼Œè·å–CMA areaçš„ä½ç½®ï¼ˆèµ·å§‹åœ°å€ï¼Œå¤§å°ï¼‰ï¼Œå¹¶è°ƒç”¨cma\_declare\_contiguousæ¥å£å‡½æ•°å‘CMAæ¨¡å—è¿›è¡Œæ³¨å†Œï¼ˆå½“ç„¶ï¼Œå’Œdevice treeä¼ å‚ç±»ä¼¼ï¼Œæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨cma\_init\_reserved\_memæ¥å£å‡½æ•°ï¼‰ã€‚é™¤äº†å‘½ä»¤è¡Œå‚æ•°ï¼Œé€šè¿‡å†…æ ¸é…ç½®ï¼ˆCMA\_SIZE\_MBYTESå’ŒCMA\_SIZE\_PERCENTAGEï¼‰ä¹Ÿå¯ä»¥ç¡®å®šCMA areaçš„å‚æ•°ã€‚

Â 

**äº”ã€memblockã€CMAå’Œä¼™ä¼´ç³»ç»Ÿçš„åˆå§‹åŒ–é¡ºåºæ˜¯æ€æ ·çš„ï¼Ÿ**

å¥—ç”¨ä¸€å¥å¹¿å‘Šè¯ï¼šCMAå¹¶ä¸è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œå®ƒåªæ˜¯â€å†…å­˜ç®¡ç†æœºåˆ¶â€œçš„æ¬è¿å·¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCMA areaçš„å†…å­˜æœ€ç»ˆè¿˜æ˜¯è¦å¹¶å…¥ä¼™ä¼´ç³»ç»Ÿè¿›è¡Œç®¡ç†ã€‚åœ¨è¿™æ ·å¤§æ–¹å‘çš„æŒ‡å¯¼ä¸‹ï¼ŒCMAæ¨¡å—çš„åˆå§‹åŒ–å¿…é¡»è¦åœ¨é€‚å½“çš„æ—¶æœºï¼Œä»¥é€‚å½“çš„æ–¹å¼æ’å…¥åˆ°å†…å­˜ç®¡ç†ï¼ˆåŒ…æ‹¬memblockå’Œä¼™ä¼´ç³»ç»Ÿï¼‰åˆå§‹åŒ–è¿‡ç¨‹ä¸­ã€‚

å†…å­˜ç®¡ç†å­ç³»ç»Ÿè¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œé¦–å…ˆæ˜¯memblockæŒæ§å…¨å±€çš„ï¼Œè¿™æ—¶å€™éœ€è¦ç¡®å®šæ•´ä¸ªç³»ç»Ÿçš„çš„å†…å­˜å¸ƒå±€ï¼Œç®€å•è¯´å°±æ˜¯äº†è§£æ•´ä¸ªmemoryçš„åˆ†å¸ƒæƒ…å†µï¼Œå“ªäº›æ˜¯memory blockæ˜¯memory typeï¼Œå“ªäº›memory blockæ˜¯reserved typeã€‚æ¯«æ— ç–‘é—®ï¼ŒCMA areaå¯¹åº”çš„å½“ç„¶æ˜¯reserved typeã€‚æœ€å…ˆè¿›è¡Œçš„æ˜¯memory typeçš„å†…å­˜å—çš„å»ºç«‹ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š

> setup\_arch\-\-\-\>setup\_machine\_fdt\-\-\-\>early\_init\_dt\_scan\-\-\-\>early\_init\_dt\_scan\_nodes\-\-\-\>memblock\_add

éšåä¼šå»ºç«‹reserved typeçš„memory blockï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š

> setup\_arch\-\-\-\>arm64\_memblock\_init\-\-\-\>early\_init\_fdt\_scan\_reserved\_mem\-\-\-\>\_\_fdt\_scan\_reserved\_mem\-\-\-\>memblock\_reserve

å®Œæˆä¸Šé¢çš„åˆå§‹åŒ–ä¹‹åï¼Œmemblockæ¨¡å—å·²ç»é€šè¿‡device treeæ„å»ºäº†æ•´ä¸ªç³»ç»Ÿçš„å†…å­˜å…¨è²Œï¼šå“ªäº›æ˜¯æ™®é€šå†…å­˜åŒºåŸŸï¼Œå“ªäº›æ˜¯ä¿ç•™å†…å­˜åŒºåŸŸã€‚å¯¹äºé‚£äº›reserved memoryï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œåˆå§‹åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š

> setup\_arch\-\-\-\>arm64\_memblock\_init\-\-\-\>early\_init\_fdt\_scan\_reserved\_mem\-\-\-\>fdt\_init\_reserved\_mem\-\-\-\>\_\_reserved\_mem\_init\_node

ä¸Šé¢çš„ä»£ç ä¼šscanå†…æ ¸ä¸­çš„ä¸€ä¸ªç‰¹å®šçš„sectionï¼ˆè¿˜è®°å¾—å‰é¢RESERVEDMEM\_OF\_DECLAREçš„å®šä¹‰å—ï¼Ÿï¼‰ï¼Œå¦‚æœåŒ¹é…å°±ä¼šè°ƒç”¨ç›¸åº”çš„åˆå§‹åŒ–å‡½æ•°ï¼Œè€Œå¯¹äºGlobal CMA areaè€Œè¨€ï¼Œè¿™ä¸ªåˆå§‹åŒ–å‡½æ•°å°±æ˜¯rmem\_cma\_setupã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰éœ€è¦ï¼Œå…·ä½“çš„é©±åŠ¨ä¹Ÿå¯ä»¥å®šä¹‰è‡ªå·±çš„CMA areaï¼Œåˆå§‹åŒ–çš„æ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚

è‡³æ­¤ï¼Œé€šè¿‡device treeï¼Œæ‰€æœ‰çš„å†…æ ¸æ¨¡å—è¦ä¿ç•™çš„å†…å­˜éƒ½å·²ç»ææ¸…æ¥šäº†ï¼ˆä¸ä»…ä»…æ˜¯CMAä¿ç•™å†…å­˜ï¼‰ï¼Œæ˜¯æ—¶å€™é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¿ç•™CMAå†…å­˜äº†ï¼Œå…·ä½“çš„è°ƒç”¨å¦‚ä¸‹ï¼š

> setup\_arch\-\-\-\>arm64\_memblock\_init\-\-\-\>dma\_contiguous\_reserve

å®é™…ä¸Šï¼Œåœ¨æ„å»ºCMA areaä¸Šï¼Œdevice treeçš„åŠŸèƒ½å·²ç»å®Œå…¨ç¢¾å‹å‘½ä»¤è¡Œå‚æ•°ï¼Œå› æ­¤dma\_contiguous\_reserveæœ‰å¯èƒ½æ²¡æœ‰å®é™…çš„ä½œç”¨ã€‚å¦‚æœæ²¡æœ‰é€šè¿‡å‘½ä»¤è¡Œæˆ–è€…å†…æ ¸é…ç½®æ–‡ä»¶æ¥å®šä¹‰Global CMA areaï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°è°ƒç”¨å½“ç„¶ä¸ä¼šèµ·ä»€ä¹ˆä½œç”¨ï¼Œå¦‚æœdevice treeå·²ç»è®¾å®šäº†Global CMA areaï¼Œé‚£ä¹ˆå…¶å®dma\_contiguous\_reserveä¹Ÿä¸ä¼šçœŸæ­£reserve memoryï¼ˆdevice treeä¼˜å…ˆçº§é«˜äºå‘½ä»¤è¡Œï¼‰ã€‚

å¦‚æœæœ‰é…ç½®å‘½ä»¤è¡Œå‚æ•°ï¼Œè€Œä¸”device treeå¹¶æ²¡æœ‰è®¾å®šGlobal CMA areaï¼Œé‚£ä¹ˆdma\_contiguous\_reserveæ‰ä¼šçœŸæ­£æœ‰ä½œç”¨ã€‚é‚£ä¹ˆæ ¹æ®é…ç½®å‚æ•°å¯ä»¥æœ‰ä¸¤ç§åœºæ™¯ï¼šä¸€ç§æ˜¯CMA areaæ˜¯å›ºå®šä½ç½®çš„ï¼Œå³å‚æ•°ç»™å‡ºäº†ç¡®å®šçš„èµ·å§‹åœ°å€å’Œå¤§å°ï¼Œè¿™ç§æƒ…å†µæ¯”è¾ƒç®€å•ï¼Œç›´æ¥è°ƒç”¨memblock\_reserveå°±OKäº†ï¼Œå¦å¤–ä¸€ç§æƒ…å†µæ˜¯åŠ¨æ€åˆ†é…çš„ï¼Œè¿™æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨memblockçš„å†…å­˜åˆ†é…æ¥å£memblock\_alloc\_rangeæ¥ä¸ºCMA areaåˆ†é…å†…å­˜ã€‚

memblockå§‹ç»ˆæ˜¯åˆå§‹åŒ–é˜¶æ®µçš„å†…å­˜ç®¡ç†æ¨¡å—ï¼Œæœ€ç»ˆæˆ‘ä»¬è¿˜æ˜¯è¦è½¬å‘ä¼™ä¼´ç³»ç»Ÿï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

> start\_kernel\-\-\-\>mm\_init\-\-\-\>mem\_init\-\-\-\>free\_all\_bootmem\-\-\-\>free\_low\_memory\_core\_early\-\-\-\>\_\_free\_memory\_core

åœ¨ä¸Šé¢çš„è¿‡ç¨‹ä¸­ï¼Œfree memoryè¢«é‡Šæ”¾åˆ°ä¼™ä¼´ç³»ç»Ÿä¸­ï¼Œè€Œreserved memoryä¸ä¼šè¿›å…¥ä¼™ä¼´ç³»ç»Ÿï¼Œå¯¹äºCMA areaï¼Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œæœ€ç»ˆè¢«ç”±ä¼™ä¼´ç³»ç»Ÿç®¡ç†ï¼Œå› æ­¤ï¼Œåœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼ŒCMA areaçš„å†…å­˜ä¼šå…¨éƒ¨å¯¼å…¥ä¼™ä¼´ç³»ç»Ÿï¼ˆæ–¹ä¾¿å…¶ä»–åº”ç”¨å¯ä»¥é€šè¿‡ä¼™ä¼´ç³»ç»Ÿåˆ†é…å†…å­˜ï¼‰ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

> core\_initcall\(cma\_init\_reserved\_areas\);

è‡³æ­¤ï¼Œæ‰€æœ‰çš„CMA areaçš„å†…å­˜è¿›å…¥ä¼™ä¼´ç³»ç»Ÿã€‚

Â 

**å…­ã€CMAæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ**

1ã€å‡†å¤‡çŸ¥è¯†

å¦‚æœæƒ³è¦äº†è§£CMAæ˜¯å¦‚ä½•è¿ä½œçš„ï¼Œä½ å¯èƒ½éœ€è¦çŸ¥é“ä¸€ç‚¹ç‚¹å…³äºmigrate typeså’Œpageblocksçš„çŸ¥è¯†ã€‚å½“ä»ä¼™ä¼´ç³»ç»Ÿè¯·æ±‚å†…å­˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æä¾›äº†ä¸€ä¸ªgfp\_maskçš„å‚æ•°ã€‚å®ƒæœ‰å¾ˆå¤šçš„åŠŸèƒ½ï¼Œä¸è¿‡åœ¨CMAè¿™ä¸ªåœºæ™¯ï¼Œå®ƒç”¨æ¥æŒ‡å®šè¯·æ±‚é¡µé¢çš„è¿ç§»ç±»å‹ï¼ˆmigrate typeï¼‰ã€‚migrate typeæœ‰å¾ˆå¤šä¸­ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯MIGRATE\_MOVABLEç±»å‹ï¼Œè¢«æ ‡è®°ä¸ºMIGRATE\_MOVABLEçš„pageè¯´æ˜è¯¥é¡µé¢ä¸Šçš„æ•°æ®æ˜¯å¯ä»¥è¿ç§»çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†é…ä¸€ä¸ªæ–°çš„pageï¼Œcopyæ•°æ®åˆ°è¿™ä¸ªnew pageä¸Šå»ï¼Œé‡Šæ”¾è¿™ä¸ªpageã€‚è€Œå®Œæˆè¿™æ ·çš„æ“ä½œå¯¹ç³»ç»Ÿæ²¡æœ‰ä»»ä½•çš„å½±å“ã€‚æˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šå¯¹äºå†…æ ¸ä¸­çš„data sectionï¼Œå…¶å¯¹åº”çš„pageä¸æ˜¯æ˜¯movableçš„ï¼Œå› ä¸ºä¸€æ—¦ç§»åŠ¨æ•°æ®ï¼Œé‚£ä¹ˆå†…æ ¸æ¨¡å—å°±æ— æ³•è®¿é—®é‚£äº›é¡µé¢ä¸Šçš„å…¨å±€å˜é‡äº†ã€‚è€Œå¯¹äºpage cacheè¿™æ ·çš„é¡µé¢ï¼Œå…¶å®æ˜¯å¯ä»¥æ¬ç§»çš„ï¼Œåªè¦è®©æŒ‡é’ˆæŒ‡å‘æ–°çš„pageå°±OKäº†ã€‚

ä¼™ä¼´ç³»ç»Ÿä¸ä¼šè·Ÿè¸ªæ¯ä¸€ä¸ªpage frameçš„è¿ç§»ç±»å‹ï¼Œå®é™…ä¸Šå®ƒæ˜¯æŒ‰ç…§pageblockä¸ºå•ä½è¿›è¡Œç®¡ç†çš„ï¼Œmemory zoneä¸­ä¼šæœ‰ä¸€ä¸ªbitmapï¼ŒæŒ‡æ˜è¯¥zoneä¸­æ¯ä¸€ä¸ªpageblockçš„migrate typeã€‚åœ¨å¤„ç†å†…å­˜åˆ†é…è¯·æ±‚çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šé¦–å…ˆä»å’Œè¯·æ±‚ç›¸åŒmigrate typeï¼ˆgfp\_maskï¼‰çš„pageblocksä¸­åˆ†é…é¡µé¢ã€‚å¦‚æœåˆ†é…ä¸æˆåŠŸï¼Œä¸åŒmigrate typeçš„pageblocksä¸­ä¹Ÿä¼šè€ƒè™‘ï¼Œç”šè‡³å¯èƒ½æ”¹å˜pageblockçš„migrate typeã€‚è¿™æ„å‘³ç€ä¸€ä¸ªnon\-movableé¡µé¢è¯·æ±‚ä¹Ÿå¯ä»¥ä»migrate typeæ˜¯movableçš„pageblockä¸­åˆ†é…ã€‚è¿™ä¸€ç‚¹CMAæ˜¯ä¸èƒ½æ¥å—çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªæ–°çš„migrate typeï¼šMIGRATE\_CMAã€‚è¿™ç§è¿ç§»ç±»å‹å…·æœ‰ä¸€ä¸ªé‡è¦æ€§è´¨ï¼šåªæœ‰å¯ç§»åŠ¨çš„é¡µé¢å¯ä»¥ä»MIGRATE\_CMAçš„pageblockä¸­åˆ†é…ã€‚

2ã€åˆå§‹åŒ–CMA area

> static int \_\_init cma\_activate\_area\(struct cma \*cma\)
> 
> {
> 
> int bitmap\_size = BITS\_TO\_LONGS\(cma\_bitmap\_maxno\(cma\)\) \* sizeof\(long\);
> 
> unsigned long base\_pfn = cma\-\>base\_pfn, pfn = base\_pfn;
> 
> unsigned i = cma\-\>count \>\> pageblock\_order;
> 
> struct zone \*zone; ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆ1ï¼‰
> 
> cma\-\>bitmap = kzalloc\(bitmap\_size, GFP\_KERNEL\); ï¼ï¼ï¼ï¼åˆ†é…å†…å­˜
> 
> zone = page\_zone\(pfn\_to\_page\(pfn\)\); ï¼ï¼ï¼æ‰¾åˆ°pageå¯¹åº”çš„memory zone
> 
> do {ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆ2ï¼‰
> 
> unsigned j;
> 
> base\_pfn = pfn;
> 
> for \(j = pageblock\_nr\_pages; j; \-\-j, pfn\+\+\) {ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆ3ï¼‰
> 
> if \(page\_zone\(pfn\_to\_page\(pfn\)\) \!= zone\)
> 
> goto err;
> 
> }
> 
> init\_cma\_reserved\_pageblock\(pfn\_to\_page\(base\_pfn\)\);ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆ4ï¼‰
> 
> } while \(\-\-i\);
> 
> mutex\_init\(&cma\-\>lock\);
> 
> return 0;
> 
> err:
> 
> kfree\(cma\-\>bitmap\);
> 
> cma\-\>count = 0;
> 
> return \-EINVAL;
> 
> }

ï¼ˆ1ï¼‰CMA areaæœ‰ä¸€ä¸ªbitmapæ¥ç®¡ç†å„ä¸ªpageçš„çŠ¶æ€ï¼Œè¿™é‡Œbitmap\_sizeç»™å‡ºäº†bitmapéœ€è¦å¤šå°‘çš„å†…å­˜ã€‚iå˜é‡è¡¨ç¤ºè¯¥CMA areaæœ‰å¤šå°‘ä¸ªpageblockã€‚

ï¼ˆ2ï¼‰éå†è¯¥CMA areaä¸­çš„æ‰€æœ‰çš„pageblockã€‚

ï¼ˆ3ï¼‰ç¡®ä¿CMA areaä¸­çš„æ‰€æœ‰pageéƒ½æ˜¯åœ¨ä¸€ä¸ªmemory zoneå†…ï¼ŒåŒæ—¶ç´¯åŠ äº†pfnï¼Œä»è€Œå¾—åˆ°ä¸‹ä¸€ä¸ªpageblockçš„åˆå§‹page frame numberã€‚

ï¼ˆ4ï¼‰å°†è¯¥pageblockå¯¼å…¥åˆ°ä¼™ä¼´ç³»ç»Ÿï¼Œå¹¶ä¸”å°†migrate typeè®¾å®šä¸ºMIGRATE\_CMAã€‚

2ã€åˆ†é…è¿ç»­å†…å­˜

cma\_allocç”¨æ¥ä»æŒ‡å®šçš„CMA areaä¸Šåˆ†é…countä¸ªè¿ç»­çš„page frameï¼ŒæŒ‰ç…§alignå¯¹é½ã€‚å…·ä½“çš„ä»£ç å°±ä¸å†åˆ†æäº†ï¼Œæ¯”è¾ƒç®€å•ï¼Œå®é™…ä¸Šå°±æ˜¯ä»bitmapä¸Šæœç´¢free pageçš„è¿‡ç¨‹ï¼Œä¸€æ—¦æœç´¢åˆ°ï¼Œå°±è°ƒç”¨alloc\_contig\_rangeå‘ä¼™ä¼´ç³»ç»Ÿç”³è¯·å†…å­˜ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCMAå†…å­˜åˆ†é…è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ¯”è¾ƒâ€œé‡â€çš„æ“ä½œï¼Œå¯èƒ½æ¶‰åŠé¡µé¢è¿ç§»ã€é¡µé¢å›æ”¶ç­‰æ“ä½œï¼Œå› æ­¤ä¸é€‚åˆç”¨äºatomic contextã€‚

3ã€é‡Šæ”¾è¿ç»­å†…å­˜

åˆ†é…è¿ç»­å†…å­˜çš„é€†è¿‡ç¨‹ï¼Œé™¤äº†bitmapçš„æ“ä½œä¹‹å¤–ï¼Œæœ€é‡è¦çš„å°±æ˜¯è°ƒç”¨free\_contig\_rangeï¼Œå°†æŒ‡å®šçš„pagesè¿”å›ä¼™ä¼´ç³»ç»Ÿã€‚

**ä¸ƒã€CMAå†…æ ¸æºç åˆ†æ**

1ã€ä¿ç•™16MÂ å†…å­˜ï¼Œ16Mæ˜¯linuxå†…æ ¸çš„ä¸€ä¸ªé»˜è®¤å€¼ï¼Œå…·ä½“ä¿ç•™é•¿åº¦è¿˜å¯ä»¥è°ƒæ•´ã€‚å¹¶åˆå§‹åŒ–cmaæ•°æ®ç»“æ„

dma\_contiguous\_reserve\-\>dma\_contiguous\_reserve\_area\-\>dma\_contiguous\_reserve\_area\-ã€‹cma\_declare\_contiguous\-ã€‹memblock\_alloc\_range/cma\_init\_reserved\_mem

**![562cbb37a9820135ab387b3ea38a00c2.png](image/562cbb37a9820135ab387b3ea38a00c2.png)**

**cma\_init\_reserved\_mem:Â Â** **This function creates custom contiguous area from already reserved memoryÂ åˆå§‹åŒ–cmaç»“æ„ä½“**

**![8cd394a4ef139ed29010ade7ce5b23bb.png](image/8cd394a4ef139ed29010ade7ce5b23bb.png)**

**2ã€****cma\_init\_reserved\_areas\-ã€‹****cma\_activate\_area\-\>****init\_cma\_reserved\_pageblock**

pageblock\_order: å†…æ ¸è®¤ä¸ºå¤Ÿå¤§çš„ä¸€ä¸ªåˆ†é…çš„é˜¶ã€‚

pageblock\_nr\_pages: å†…æ ¸è®¤ä¸ºå¯ç”¨è¯¥ç‰¹æ€§æ—¶æ¯ä¸ªè¿ç§»é“¾è¡¨éœ€è¦å…·æœ‰çš„æœ€å°‘çš„å†…å­˜é¡µæ•°ã€‚å®ƒçš„å®šä¹‰æ˜¯åŸºäºpageblock\_orderçš„ã€‚ï¼ˆ1\<\<10ï¼‰ä¸ªpageç»„æˆä¸€ä¸ªpageblock

```
#define pageblock_orderâ–¼â–¼Â Â Â Â Â Â Â (MAX_ORDER-1)
#define MAX_ORDER 11
#define pageblock_nr_pagesâ–¼Â Â Â Â Â (1UL << pageblock_order)
```

init\_cma\_reserved\_pageblockï¼šFree whole pageblock and set its migration type to MIGRATE\_CMA.

å°†è¯¥pageblockå¯¼å…¥åˆ°ä¼™ä¼´ç³»ç»Ÿï¼Œå¹¶ä¸”å°†migrate typeè®¾å®šä¸ºMIGRATE\_CMA ã€‚è¯¦ç»†çš„æ“ä½œæ²¡å¤ªçœ‹æ‡‚ã€‚

![4777c1171c0956f1db146a8a68511aad.png](image/4777c1171c0956f1db146a8a68511aad.png)

3ã€åˆ†é…å’Œé‡Šæ”¾cmaå†…å­˜ï¼Œå…¶æœ€ç»ˆè¿˜éœ€è¦é€šè¿‡ä¼™ä¼´ç³»ç»Ÿçš„æ¥å£è¿›è¡Œå¤„ç†ï¼Œåœ¨page\_alloc.cä¸­ã€‚DMAæ¨¡å—ä¸­åˆ™å°è£…åˆ†é…å’Œé‡Šæ”¾æ¥å£ï¼Œä»¥æä¾›å†…å­˜ç»™DMAä½¿ç”¨ã€‚

cma\_alloc\-ã€‹ alloc\_contig\_range\(pfn, pfn \+ count, MIGRATE\_CMA\)Â  ä»cmaè¿ç»­å†…å­˜ä¸­åˆ†é…å†…å­˜

cma\_release\-ã€‹free\_contig\_range\(pfn, count\);

![85b58f98b7fad4701ac824cf1b75308a.png](image/85b58f98b7fad4701ac824cf1b75308a.png)

![1b17857ab474bae96b09aee6f3c2b431.png](image/1b17857ab474bae96b09aee6f3c2b431.png)

![f34c1abc06e367377474a43de834cfee.png](image/f34c1abc06e367377474a43de834cfee.png)

è°ƒç”¨cmaå†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„æºå¤´ä»£ç ä¸ºï¼šdma\_alloc\_coherent/dma\_free\_coherent

è¯¥æ¥å£

4ã€æ•°æ®ç»“æ„

**![974a8c38eb4f0d10b21b4a6f421220f4.png](image/974a8c38eb4f0d10b21b4a6f421220f4.png)**

é€šè¿‡buddyåˆ†é¡µæ—¶ï¼Œä½•æ—¶ä½¿ç”¨cmaå†…å­˜ï¼Ÿ

%\!\(EXTRA markdown.ResourceType=, string=, string=\)

1ã€é¦–å…ˆæ‰«ææŒ‡å®šmigratetypeçš„åˆ—è¡¨ï¼Œè¿”å›ç›¸åº”çš„page

2ã€å¦‚æœå†1ä¸­æœªæ‰¾åˆ°ï¼Œä¸”migratetypeæ˜¯MIGRATE\_MOVABLEç±»å‹ï¼Œå¦‚ç”¨æˆ·ç©ºé—´æ˜ å°„çš„ç‰©ç†é¡µï¼Œå¯ä»¥è¿›è¡Œé¡µè¿ç§»çš„å†…å­˜ç±»å‹æ—¶ï¼Œå¯ä»¥åˆ†é…CMAÂ MIGRATE\_CMAç±»å‹çš„ç‰©ç†é¡µ

Â  Â  ä»¥æ­¤å®ç°å†…å­˜ä¸è¶³æ—¶ä½¿ç”¨CMAÂ å†…å­˜ã€‚

3ã€æ— æ³•æ»¡è¶³ä»¥ä¸Šæ¡ä»¶åï¼Œè¿›è¡Œé™çº§é¡µåˆ†é…
