# å¹¶å‘åŒæ­¥ä¹‹æ— é”ç¼–ç¨‹

**ä¸€ã€ æ— é”ç¼–ç¨‹ä»‹ç»**

**1.1 æ— é”ç¼–ç¨‹ / lock\-free / éé˜»å¡åŒæ­¥**

æ— é”ç¼–ç¨‹ï¼Œå³ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹å®ç°å¤šçº¿ç¨‹ä¹‹é—´çš„å˜é‡åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯åœ¨æ²¡æœ‰çº¿ç¨‹è¢«é˜»å¡çš„æƒ…å†µä¸‹å®ç°å˜é‡çš„åŒæ­¥ï¼Œæ‰€ä»¥ä¹Ÿå«éé˜»å¡åŒæ­¥ï¼ˆNon\-blocking Synchronizationï¼‰ã€‚å®ç°éé˜»å¡åŒæ­¥çš„æ–¹æ¡ˆç§°ä¸ºâ€œæ— é”ç¼–ç¨‹ç®—æ³•â€ï¼ˆ Non\-blocking algorithmï¼‰ã€‚

lock\-freeæ˜¯ç›®å‰æœ€å¸¸è§çš„æ— é”ç¼–ç¨‹çš„å®ç°çº§åˆ«ï¼ˆä¸€å…±ä¸‰ç§çº§åˆ«ï¼Œæœ€æ–°perfbookä¸­æœ‰åˆ—å‡ºä¸ƒä¸ªçº§åˆ«ï¼‰ã€‚

**1.2Â æ— é”ç¼–ç¨‹åˆ†çº§Â** 

éåŒæ­¥é˜»å¡çš„å®ç°å¯ä»¥åˆ†æˆä¸‰ä¸ªçº§åˆ«ï¼šwait\-free/lock\-free/obstruction\-freeã€‚

**wait\-free**

æ˜¯æœ€ç†æƒ³çš„æ¨¡å¼ï¼Œæ•´ä¸ªæ“ä½œä¿è¯æ¯ä¸ªçº¿ç¨‹åœ¨æœ‰é™æ­¥éª¤ä¸‹å®Œæˆã€‚ä¿è¯ç³»ç»Ÿçº§ååï¼ˆsystem\-wide throughputï¼‰ä»¥åŠæ— çº¿ç¨‹é¥¥é¥¿ã€‚æˆªæ­¢2011å¹´ï¼Œæ²¡æœ‰å¤šå°‘å…·ä½“çš„å®ç°ã€‚å³ä½¿å®ç°äº†ï¼Œä¹Ÿéœ€è¦ä¾èµ–äºå…·ä½“CPUã€‚

**lock\-free**

å…è®¸ä¸ªåˆ«çº¿ç¨‹é¥¥é¥¿ï¼Œä½†ä¿è¯ç³»ç»Ÿçº§ååã€‚ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç»§ç»­æ‰§è¡Œã€‚wait\-freeçš„ç®—æ³•å¿…å®šä¹Ÿæ˜¯lock\-freeçš„ã€‚

**obstruction\-free**

åœ¨ä»»ä½•æ—¶é—´ç‚¹ï¼Œä¸€ä¸ªçº¿ç¨‹è¢«éš”ç¦»ä¸ºä¸€ä¸ªäº‹åŠ¡è¿›è¡Œæ‰§è¡Œï¼ˆå…¶ä»–çº¿ç¨‹suspendedï¼‰ï¼Œå¹¶ä¸”åœ¨æœ‰é™æ­¥éª¤å†…å®Œæˆã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°æ•°æ®è¢«ä¿®æ”¹ï¼ˆé‡‡ç”¨æ—¶é—´æˆ³ã€ç‰ˆæœ¬å·ï¼‰ï¼Œåˆ™å›æ»šã€‚ä¹Ÿå«åšä¹è§‚é”ï¼Œå³ä¹è§‚å¹¶å‘æ§åˆ¶\(OOC\)ã€‚äº‹åŠ¡çš„è¿‡ç¨‹æ˜¯ï¼š1è¯»å–ï¼Œå¹¶å†™æ—¶é—´æˆ³ï¼›2å‡†å¤‡å†™å…¥ï¼Œç‰ˆæœ¬æ ¡éªŒï¼›3æ ¡éªŒé€šè¿‡åˆ™å†™å…¥ï¼Œæ ¡éªŒä¸é€šè¿‡ï¼Œåˆ™å›æ»šã€‚lock\-freeå¿…å®šæ˜¯obstruction\-freeçš„ã€‚

**1.3Â ä¸ºä½•éœ€è¦non\-blockÂ sync**

ä½¿ç”¨lockå®ç°çº¿ç¨‹åŒæ­¥æœ‰å¾ˆå¤šç¼ºç‚¹ï¼š

\* äº§ç”Ÿç«äº‰æ—¶ï¼Œçº¿ç¨‹è¢«é˜»å¡ç­‰å¾…ï¼Œæ— æ³•åšåˆ°çº¿ç¨‹å®æ—¶å“åº”ã€‚

\* dead lockã€‚

\* live lockã€‚

\* ä¼˜å…ˆçº§ç¿»è½¬ã€‚

\* ä½¿ç”¨ä¸å½“ï¼Œé€ æˆæ€§èƒ½ä¸‹é™ã€‚

å¦‚æœåœ¨ä¸ä½¿ç”¨ lock çš„æƒ…å†µä¸‹ï¼Œå®ç°å˜é‡åŒæ­¥ï¼Œé‚£å°±ä¼šé¿å…å¾ˆå¤šé—®é¢˜ã€‚è™½ç„¶ç›®å‰æ¥çœ‹ï¼Œæ— é”ç¼–ç¨‹å¹¶ä¸èƒ½æ›¿ä»£ lockã€‚

**ä¸‰ã€å†…æ ¸æ— é”ç¼–ç¨‹çš„å‡ ç§å®ç°**

**3.1Â å•æŒ‡é’ˆæ— é”**

**3.1.1Â å•æŒ‡é’ˆæ— é”å®ç°æ¨¡å‹**

```
Â Â Â Â thread 1Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â thread 2
Â Â Â Â --------------------------------Â Â Â Â Â Â ------------------------
Â Â Â Â a.x = 1;
Â  Â  //å†™å±éšœæŠ‘åˆ¶ä¸ç›¸å…³åœ°å€çš„store-storeä¹±åº
Â Â Â Â smp_wmb();Â 
Â  Â  //WRITE_ONCEæŠ‘åˆ¶storeÂ tearing
Â Â Â Â WRITE_ONCE(message, &a);Â Â Â Â Â Â Â Â Â Â Â Â Â Â datum = READ_ONCE(message); //READ_ONCEæŠ‘åˆ¶loadÂ tearing
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â smp_rmb();Â  //å­˜åœ¨ç›¸å…³åœ°å€ä¾èµ–load-loadï¼Œä½¿ç”¨è¯»ä¾èµ–å±éšœå³å¯
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (datum != NULL)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â printk("%x\n", datum->x);
```

ä»æ¨¡å‹å®ç°çœ‹ï¼Œä¸rcuæ— é”æœºåˆ¶éå¸¸ç±»ä¼¼ï¼Œå…¶ç‰¹å¾å¦‚ä¸‹ï¼š

1ã€ç”±äºå†™ç«¯æ•°æ®æ›´æ–°æ—¶ï¼Œåªéœ€æ›´æ–°å…¨å±€æŒ‡é’ˆmessageï¼Œå› æ­¤å¤šä¸ªå†™ç«¯å¯ä»¥é‡å…¥è€Œä¸éœ€è¦é¢å¤–çš„é”ä¿æŠ¤ï¼Œä½†æ˜¯ä¸åƒrcuæœ‰å°è£…å¥½çš„æœºåˆ¶å†™ç«¯å¯ä»¥é‡Šæ”¾æ—§çš„æ•°æ®

2ã€ç±»ä¼¼rcuè¯»ç«¯å¯ä»¥å¹¶å‘ï¼Œä½†æ˜¯æŒæœ‰çš„æ•°æ®å¯èƒ½æ˜¯æ—§çš„æ•°æ®

3ã€å†™ç«¯ä¸å…·å¤‡å¯¹æ—§æ•°æ®å›æ”¶å¤„ç†èƒ½åŠ›

**3.1.2Â å•æŒ‡é’ˆæ— é”ä½¿ç”¨åœºæ™¯**

1ï¼‰ring buffer æ–¹æ¡ˆ

ring buffer ä¸­æ¯ä¸€é¡¹å¾€å¾€éƒ½æŒ‡å‘å…¶ä»–çš„æ•°æ®ï¼Œä¸€èˆ¬æ¥è¯´è¿˜ä¼šæœ‰ä¸€äº› head/tail çš„ä¿¡æ¯éƒ½æ˜¯æŒ‡å‘ ring buffer ä¸­æŸä¸ªä½ç½®çš„ç´¢å¼•ã€‚ç»™ ring buffer å¡«æ•°æ®çš„ä¸€æ–¹ï¼ˆproducerï¼‰ä¼šä½¿ç”¨ store\-release æ“ä½œï¼Œè¿™æ ·å°±èƒ½ä¸ consumerï¼ˆè¯»å– ring buffer ä¸­çš„æ•°æ®çš„ä¸€æ–¹ï¼‰ç¡®ä¿åŒæ­¥ã€‚

2ï¼‰RCUçš„å®ç°

åœ¨ compiler çœ‹æ¥ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ rcu\_dereference\(\) å’Œ rcu\_assign\_pointer\(\) API è·Ÿ load\-acquire å’Œ store\-release æ“ä½œæ˜¯ä¸€ä¸ªæ•ˆæœã€‚å¾—ç›Šäºé™¤äº† Alpha ä»¥å¤–çš„å…¶ä»–å¤„ç†å™¨ä¸­éƒ½å…·æœ‰çš„ä¸€äº›ç‰¹æ€§ï¼Œrcu\_dereference\(\) å°±å¯ä»¥è¢«ç›´æ¥ç¼–è¯‘æˆæ™®é€šçš„ load æ“ä½œï¼Œæ­¤æ—¶ rcu\_assign\_pointer\(\) ä»ç„¶è·Ÿ rcu\_dereference\(\)æ“ä½œæ˜¯ç¡®ä¿åŒæ­¥çš„ï¼Œå°±å¥½åƒå®ƒè¿˜æ˜¯ä¸€ä¸ª load\-acquire æ“ä½œä¸€æ ·ã€‚

å…³äºrcuä¸æ— é”çš„å…³ç³»ï¼š

\* Read\-copy\-update with a single writer and any number of readers. \(The readers are wait\-free; the writer is usually lock\-free, until it needs to reclaim memory\).

\* Read\-copy\-update with multiple writers and any number of readers. \(The readers are wait\-free; multiple writers generally serialize with a lock and are not obstruction\-free\).

3ï¼‰å°†æŒ‡é’ˆå†™å…¥æ•°ç»„æ—¶

åœ¨ä¸‹é¢çš„ KVM ä»£ç ä¸­ï¼ˆç®€å†™è¿‡çš„ï¼‰ï¼Œå†™ç«¯é€šè¿‡ä¿®æ”¹å•æŒ‡ä»¤ä¿®æ”¹kvm\-\>online\_vcpusè¿›è¡Œæ›´æ–°æ“ä½œï¼Œè€ƒè™‘åˆ°å…¶æ›´æ–°æ—¶æ˜¯éœ€è¦å¤šæ­¥æ“ä½œï¼Œå› æ­¤è¯¥åœºæ™¯æ— é”çŠ¶æ€ä¸‹åªèƒ½æœ‰å•ä¸ªå†™ï¼Œå¯ä»¥æœ‰å¤šä¸ªè¯»å¹¶å‘ã€‚

```
Â Â Â Â kvm_vm_ioctl_create_vcpu()Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â kvm_get_vcpu()
Â Â Â Â -----------------------------------------Â Â Â Â Â Â -----------------------------------------------
Â Â Â Â kvm->vcpus[kvm->online_vcpus] = vcpu;Â Â Â Â Â Â Â Â Â Â if (idx < smp_load_acquire(&kvm->online_vcpus))
Â Â Â Â smp_store_release(&kvm->online_vcpus,Â Â Â Â Â Â Â Â Â Â Â Â return kvm->vcpus[idx];
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â kvm->online_vcpus + 1);Â Â Â Â Â Â return NULL;
```

**3.2Â seqcountæ— é”**

**3.2.1 seqcountæ— é”å®ç°æ¨¡å‹**

```
Â Â Â Â thread 1 (buggy writer)Â Â Â Â Â Â Â Â Â Â Â Â Â thread 2 (buggy reader)
Â Â Â Â --------------------------------Â Â Â Â ------------------------
Â Â Â Â WRITE_ONCE(sc, sc + 1);Â Â Â Â Â Â Â Â Â Â Â Â Â do {
Â Â Â Â smp_store_release(&data.x, 123);Â Â Â Â Â Â Â Â old = smp_load_acquire(&sc) & ~1;
Â Â Â Â WRITE_ONCE(data.y, 456);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â copy.y = READ_ONCE(data.y);
Â Â Â Â smp_store_release(&sc, sc + 1);Â Â Â Â Â Â Â Â Â copy.x = smp_load_acquire(&data.x);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } while(READ_ONCE(sc) != old);
```

seqcountæ— é”æœ¬è´¨ä¸Šæ˜¯é€šè¿‡seqcountçš„å¥‡å¶æ€§æ¥è¡¨æ˜å½“å‰ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯å¦å®Œæ•´ï¼Œè€Œè¯»ç«¯é€šè¿‡å¤šæ¬¡å¾ªç¯é‡è¯•æ¥åˆ¤æ–­seqcountçš„å¥‡å¶æ¥ç¡®è®¤å½“å‰æ•°æ®æ˜¯å¦å®Œæ•´ã€‚seqcountæœ¬èº«çš„æ›´æ–°è¯»å–æ˜¯å•æŒ‡ä»¤æ“ä½œï¼Œä¸”éœ€è¦ä½¿ç”¨WRITE\_ONCE/READ\_ONCEæ¥æŠ‘åˆ¶store/loadÂ tearingé—®é¢˜ã€‚è¿™ç±»æ— é”å®ç°å…·å¤‡å¦‚ä¸‹ç‰¹å¾ï¼š

1ã€åœ¨æ— é¢å¤–é”ä¿æŠ¤çš„æƒ…å†µä¸‹ï¼Œå†™ç«¯ä¸èƒ½å¹¶å‘ï¼Œå¹¶å‘å¯èƒ½é€ æˆæ•°æ®æ··ä¹±ï¼Œè¯»ç«¯å¯ä»¥å¹¶å‘

2ã€è¯»ç«¯éœ€è¦ä½¿ç”¨å¤šæ¬¡é‡è¯•æ¥åˆ¤æ–­å½“å‰æ•°æ®æ˜¯å¦å®Œæ•´ï¼Œå› æ­¤è¯»ç«¯è€—æ—¶é•¿ï¼Œä¸”ä¸ä¼šé˜»å¡å†™ç«¯

3ã€è¯¥å®ç°å±äºå•ç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å‹

**3.2.2Â seqcountæ— é”ä½¿ç”¨åœºæ™¯**

Linuxå†…æ ¸ä¸­seqlocké”åŸºäºæ­¤åŸç†å®ç°ã€‚

**3.3Â Sleep/wake\-up synchronizationæ— é”**

**3.3.1Â Sleep/wake\-up synchronizationå®ç°æ¨¡å‹**

```
thread 1Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â thread 2
-------------------Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â --------------------------
WRITE_ONCE(dont_sleep, 1);Â Â Â Â Â Â Â Â Â Â Â Â Â if (!READ_ONCE(dont_sleep)) {
smp_mb();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â WRITE_ONCE(wake_me, 1);
if (READ_ONCE(wake_me))Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â smp_mb();
Â Â Â Â wake(thread2);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (!READ_ONCE(dont_sleep))
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â sleep();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
```

1ã€"two thread and two flags" æ¨¡å¼ï¼ˆå³æ¯ä¸ªçº¿ç¨‹å‘ä¸€ä¸ª flag å†™å…¥ã€å¹¶ä»å¦ä¸€ä¸ª flag è¯»å–ï¼‰

2ã€å¦‚ä¸Šé€šè¿‡å¢åŠ å¯¹ä¸¤ä¸ªflagçš„åˆ¤æ–­ï¼šå¯ä»¥å®ç°åªè¦å¦‚ä¸Šthread1å…ˆè¿è¡Œï¼Œé‚£ä¹ˆthread2å¿…ç„¶ä¸ä¼šå†è¿›å…¥ä¼‘çœ ï¼›

3ã€å¦‚ä¸Šä»£ç thread2ä¸­ï¼Œå¦‚æœREAD\_ONCE\(dont\_sleep\)å’Œåœ¨sleep\(\)é—´è¢«æ‰“æ–­ï¼Œåˆ™å¯èƒ½å‡ºç°thread1å…ˆæ‰§è¡Œwakeï¼Œthread2åsleepã€‚é‚£ä¹ˆè¦ä¿è¯å‰é¢çš„æè¿°æ­£ç¡®ï¼Œé‚£ä¹ˆéœ€è¦å‡å®šthread1çš„wakeä¸ä¼šä¸¢å¤±ã€‚

å­˜åœ¨é—®é¢˜çš„æ¨¡å‹ï¼š

```
thread 1Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â thread 2
-------------------Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â --------------------------
if (READ_ONCE(wake_me)) {Â  Â  Â  Â  Â  Â  Â  Â  WRITE_ONCE(wake_me, 1);
Â  Â  WRITE_ONCE(wake_me, 0);Â  Â  Â  Â  Â  Â  Â  sleep();
Â  Â  wake(thread2);
}
```

ä»¥ä¸Šç®€å•çš„å”¤é†’æ¨¡å‹å­˜åœ¨é—®é¢˜ï¼š

1ã€å¦‚æœthread2åœ¨WRITE\_ONCE\(\)å’Œsleep\(\)ä¹‹é—´è¢«thread1æ‰“æ–­ï¼Œåˆ™å­˜åœ¨missdÂ wakeupï¼ˆé”™è¿‡å”¤é†’é—®é¢˜ï¼‰

2ã€å¦‚æœthread1åœ¨ifå¤„ç†å’ŒWRITE\_ONCE\(\)ä¹‹é—´è¢«æ‰“æ–­ï¼Œåˆ™wake\_meä¼šç”±1å˜æˆ0ï¼Œå¯¼è‡´

**3.3.2Â Â Sleep/wake\-up synchronizationÂ ä½¿ç”¨åœºæ™¯**

å†…æ ¸ä¸­å¾ˆå¤šè¿™ç§åœºæ™¯ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š

1ï¼‰workqueue ä½¿ç”¨è¿™ä¸ªæ–¹å¼æ¥å†³å®šæ˜¯å¦æœ‰æ›´å¤šçš„å·¥ä½œéœ€è¦ worker å»åšã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œthread 1 çš„è§’è‰²å°±è¢«æ¢æˆ insert\_work\(\)ï¼Œè€Œ thread 2 åˆ™å˜æˆ wq\_worker\_sleeping\(\)ã€‚

2ï¼‰åœ¨ futex\(\)ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œthread 1 çš„ write æ˜¯åœ¨ user space å‘ç”Ÿçš„ï¼Œè€Œ memory barrier å’Œ read æ“ä½œåˆ™æ˜¯ futex\(FUTEX\_WAKE\)å†…éƒ¨å®ç°çš„ã€‚thread 2 çš„æ“ä½œå°±å®Œå…¨æ˜¯ futex\(FUTEX\_WAIT\)çš„ä¸€éƒ¨åˆ†ï¼ˆå› ä¸º wake\_me æ˜¯ kernel memory ä¸­çš„ä¸€ä¸ª flag\)ï¼›FUTEX\_WAIT ä¼šä½¿ç”¨ futex çš„é¢„æœŸå€¼ä½œä¸ºç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œå¹¶ç”¨å®ƒæ¥å†³å®šæ˜¯å¦ sleepã€‚å…³äºè¿™é‡Œå…·ä½“æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„ï¼Œå¯ä»¥å‚è§ kernel/futex.c æ–‡ä»¶å¼€å¤´çš„é•¿é•¿çš„æ³¨é‡Šã€‚

**3.4 CAS\(swap and store\)æ— é”å®ç°**

**3.4.1 CASæ— é”å®ç°æ¨¡å‹**

å¤šæ¶ˆè´¹è€…å¤š

```
//æ¶ˆè´¹è€…
struct llist_node *llist_del_first(struct llist_head *head)
{
Â Â Â Â Â Â Â Â struct llist_node *entry, *old_entry, *next;
Â Â Â Â Â Â Â Â entry = smp_load_acquire(&head->first);
Â Â Â Â Â Â Â Â for (;;) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (entry == NULL)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return NULL;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â old_entry = entry;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â next = READ_ONCE(entry->next);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â entry = cmpxchg(&head->first, old_entry, next);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (entry == old_entry)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â break;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â return entry;
}

//ç”Ÿäº§è€…
static inline bool llist_add(struct llist_node *new, struct llist_head *head)
{
Â Â Â Â Â Â Â Â return llist_add_batch(new, new, head);
}
bool llist_add_batch(struct llist_node *new_first, struct llist_node *new_last, struct llist_head *head)
{
Â Â Â Â Â Â Â Â struct llist_node *first;

Â Â Â Â Â Â Â Â do {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â new_last->next = first = ACCESS_ONCE(head->first);
Â Â Â Â Â Â Â Â } while (cmpxchg(&head->first, first, new_first) != first);

Â Â Â Â Â Â Â Â return !first;
}
```

1ã€llist\_del\_first\(\)ä¸º llist å®ç°äº† LIFO ï¼ˆlastÂ inÂ firstÂ outï¼‰çš„è¯­ä¹‰ã€‚å¦‚æœéœ€è¦ FIFO é¡ºåºï¼Œå¯ä»¥ä½¿ç”¨ llist\_reverse\_order\(\)æ¥å®ç°ã€‚

2ã€å¦‚ä¸Šæ¨¡å‹å½“å­˜åœ¨å¤šæ¶ˆè´¹è€…å¹¶å‘ä¼šé€ æˆABAé—®é¢˜ï¼Œä¸Šé¢å•é“¾è¡¨ä¸­å¦‚æœå‡ºç°ABAé—®é¢˜ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š

![lockless_list_ABA.jpg](image/lockless_list_ABA.jpg)

ï¼ˆ1ï¼‰æ¶ˆè´¹è€…çº¿ç¨‹thread 1å°è¯•popå‡ºå…ƒç´ ï¼Œéœ€å…ˆæ‹¿åˆ°A.nextä½œä¸ºpopæ“ä½œçš„ä¸€éƒ¨åˆ†ï¼Œæ­¤æ—¶é“¾è¡¨çŠ¶æ€è§ä¸Šå›¾æœ€ä¸Š

ï¼ˆ2ï¼‰æ¶ˆè´¹è€…çº¿ç¨‹thread 2æŠ¢å thread 1ï¼Œå®ŒæˆpopÂ Aï¼›popÂ Bï¼›pushÂ Aä¸‰ä¸ªåŠ¨ä½œï¼ˆå°æ¦‚ç‡ç‰¹æ®Šæƒ…å†µï¼‰åçº¿ç¨‹é€€å‡º ï¼Œæ­¤æ—¶é“¾è¡¨çŠ¶æ€è§ä¸Šå›¾ä¸­é—´

ï¼ˆ3ï¼‰æ¶ˆè´¹è€…çº¿ç¨‹thread 1æ¥ç€æ­¥éª¤\(1\)ç»§ç»­è¿è¡Œã€‚æ­¤æ—¶å…¶æŒæœ‰çš„A.nextç­‰äº&Bï¼Œç”±äºå½“å‰é“¾è¡¨head\-\>firstä¾ç„¶æ˜¯&Aï¼Œå…¶å¹¶æœªå‘ç°é“¾è¡¨A.nextå·²å‘ç”Ÿå˜åŒ–ä¸º&Cï¼Œæ‰€ä»¥å…¶å°†head\-\>firsté”™è¯¯è®¾å®šä¸º&Bï¼Œé“¾è¡¨çŠ¶æ€è§ä¸Šå›¾æœ€ä¸‹

ï¼ˆ4ï¼‰æœ€ç»ˆç»“æœå¯¼è‡´é“¾è¡¨head\-\>firsté”™è¯¯é€ æˆå¼‚å¸¸

```
ABAé—®é¢˜ï¼š
* åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹CASä¼šå‡ºç°ABAé—®é¢˜ï¼Œå…³äºABAé—®é¢˜è¿™é‡Œç®€å•ç§‘æ™®ä¸‹ï¼Œä¾‹å¦‚æœ‰2ä¸ªçº¿ç¨‹åŒæ—¶å¯¹åŒä¸€ä¸ªå€¼(åˆå§‹å€¼ä¸ºA)è¿›è¡ŒCASæ“ä½œï¼Œè¿™ä¸‰ä¸ªçº¿ç¨‹å¦‚ä¸‹
Â Â Â Â * 1.çº¿ç¨‹1ï¼ŒæœŸæœ›å€¼ä¸ºAï¼Œæ¬²æ›´æ–°çš„å€¼ä¸ºB
Â Â Â Â * 2.çº¿ç¨‹2ï¼ŒæœŸæœ›å€¼ä¸ºAï¼Œæ¬²æ›´æ–°çš„å€¼ä¸ºB
* çº¿ç¨‹1æŠ¢å…ˆè·å¾—CPUæ—¶é—´ç‰‡ï¼Œè€Œçº¿ç¨‹2å› ä¸ºå…¶ä»–åŸå› é˜»å¡äº†ï¼Œçº¿ç¨‹1å–å€¼ä¸æœŸæœ›çš„Aå€¼æ¯”è¾ƒï¼Œå‘ç°ç›¸ç­‰ç„¶åå°†å€¼æ›´æ–°ä¸ºBï¼Œç„¶åè¿™ä¸ªæ—¶å€™å‡ºç°äº†çº¿ç¨‹3ï¼ŒæœŸæœ›å€¼ä¸ºBï¼Œæ¬²æ›´æ–°çš„å€¼ä¸ºAï¼Œçº¿ç¨‹3å–å€¼ä¸æœŸæœ›çš„å€¼Bæ¯”è¾ƒï¼Œå‘ç°ç›¸ç­‰åˆ™å°†å€¼æ›´æ–°ä¸ºAï¼Œæ­¤æ—¶çº¿ç¨‹2ä»é˜»å¡ä¸­æ¢å¤ï¼Œå¹¶ä¸”è·å¾—äº†CPUæ—¶é—´ç‰‡ï¼Œè¿™æ—¶å€™çº¿ç¨‹2å–å€¼ä¸æœŸæœ›çš„å€¼Aæ¯”è¾ƒï¼Œå‘ç°ç›¸ç­‰åˆ™å°†å€¼æ›´æ–°ä¸ºBï¼Œè™½ç„¶çº¿ç¨‹2ä¹Ÿå®Œæˆäº†æ“ä½œï¼Œä½†æ˜¯çº¿ç¨‹2å¹¶ä¸çŸ¥é“å€¼å·²ç»ç»è¿‡äº†A->B->Açš„å˜åŒ–è¿‡ç¨‹ã€‚
* è§£å†³æ–¹æ³•ï¼š åœ¨å˜é‡å‰é¢åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™å˜é‡çš„ç‰ˆæœ¬å·éƒ½+1ï¼Œå³A->B->Aå°±å˜æˆäº†1A->2B->3Aã€‚
```

**3.4.2Â CASæ— é”ä½¿ç”¨åœºæ™¯**

**å››ã€å†…æ ¸æ— é”ç¼–ç¨‹æ€§èƒ½æ¢è®¨**

å…³äºæ— é”äºæœ‰é”çš„ç»“è®ºï¼šå¯¹äº CAS å®ç°çš„ç¡¬ä»¶çº§çš„äº’æ–¥ï¼Œå…¶å•æ¬¡æ“ä½œæ€§èƒ½æ¯”ç›¸åŒæ¡ä»¶ä¸‹çš„åº”ç”¨å±‚çš„è¾ƒä¸ºé«˜æ•ˆï¼Œä½†å½“å¤šä¸ªçº¿ç¨‹å¹¶å‘æ—¶ï¼Œç¡¬ä»¶çº§çš„äº’æ–¥å¼•å…¥çš„ä»£ä»·ä¸åº”ç”¨å±‚çš„é”äº‰ç”¨åŒæ ·ä»¤äººæƒ‹æƒœï¼Œå¤šçº¿ç¨‹ä¸‹çš„æ— é”ç¼–ç¨‹æ— ä¼˜åŠ¿ã€‚å› æ­¤å¦‚æœçº¯ç²¹å¸Œæœ›é€šè¿‡ä½¿ç”¨ CAS æ— é”ç®—æ³•åŠç›¸å…³æ•°æ®ç»“æ„è€Œå¸¦æ¥ç¨‹åºæ€§èƒ½çš„å¤§é‡æå‡æ˜¯ä¸å¯èƒ½çš„ï¼Œç¡¬ä»¶çº§åŸå­æ“ä½œä½¿åº”ç”¨å±‚æ“ä½œå˜æ…¢ï¼Œè€Œä¸”æ— æ³•å†åº¦ä¼˜åŒ–ã€‚ç›¸åé€šè¿‡å¯¹æœ‰é”å¤šçº¿ç¨‹ç¨‹åºçš„è‰¯å¥½è®¾è®¡ï¼Œå¯ä»¥ä½¿ç¨‹åºæ€§èƒ½æ²¡æœ‰ä»»ä½•ä¸‹é™ï¼Œå¯ä»¥å®ç°é«˜åº¦çš„å¹¶å‘æ€§ã€‚

å‚è€ƒèµ„æ–™

1ã€\<Lockless algorithms for mere mortals\>

åŸæ–‡ï¼šÂ [https://lwn.net/Articles/827180/](https://lwn.net/Articles/827180/)

è¯‘æ–‡ï¼š[https://blog.csdn.net/Linux\_Everything/article/details/107852904?spm=1001.2101.3001.6650.7&utm\_medium=distribute.pc\_relevant.none\-task\-blog\-2%7Edefault%7EBlogCommendFromBaidu%7Edefault\-7\-107852904\-blog\-114609710.pc\_relevant\_antiscanv4&depth\_1\-utm\_source=distribute.pc\_relevant.none\-task\-blog\-2%7Edefault%7EBlogCommendFromBaidu%7Edefault\-7\-107852904\-blog\-114609710.pc\_relevant\_antiscanv4&utm\_relevant\_index=14](https://blog.csdn.net/Linux_Everything/article/details/107852904?spm=1001.2101.3001.6650.7&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-7-107852904-blog-114609710.pc_relevant_antiscanv4&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-7-107852904-blog-114609710.pc_relevant_antiscanv4&utm_relevant_index=14)

2ã€\<An introduction to lockless algorithms\>Â Â 

åŸæ–‡ï¼š[https://lwn.net/Articles/844224/](https://lwn.net/Articles/844224/)

è¯‘æ–‡ï¼š[https://mp.weixin.qq.com/s?\_\_biz=Mzg2MjE0NDE5OA%3D%3D&chksm=ce0d14e5f97a9df3953a654e9b1f62ca4ddffc6223938f6699e0aae204b07a4c7594fa6876e1&idx=1&mid=2247485260&scene=21&sn=53a2f393565a1fa7284916166ee06c8c\#wechat\_redirect](https://mp.weixin.qq.com/s?__biz=Mzg2MjE0NDE5OA%3D%3D&chksm=ce0d14e5f97a9df3953a654e9b1f62ca4ddffc6223938f6699e0aae204b07a4c7594fa6876e1&idx=1&mid=2247485260&scene=21&sn=53a2f393565a1fa7284916166ee06c8c#wechat_redirect)

3ã€\<Lockless patterns: relaxed access and partial memory barriers\>

åŸæ–‡ï¼š[https://lwn.net/Articles/846700/](https://lwn.net/Articles/846700/)

è¯‘æ–‡ï¼š[https://mp.weixin.qq.com/s?\_\_biz=Mzg2MjE0NDE5OA%3D%3D&chksm=ce0d14caf97a9ddc0f45816ce165d44b5e7a92f458c3fa7a2df781ccc9aae8ceb290e151673f&idx=1&mid=2247485283&scene=21&sn=c73f689906feb30f3f42c7b3a1e4b67c\#wechat\_redirect](https://mp.weixin.qq.com/s?__biz=Mzg2MjE0NDE5OA%3D%3D&chksm=ce0d14caf97a9ddc0f45816ce165d44b5e7a92f458c3fa7a2df781ccc9aae8ceb290e151673f&idx=1&mid=2247485283&scene=21&sn=c73f689906feb30f3f42c7b3a1e4b67c#wechat_redirect)

4ã€\<Lockless patterns: full memory barriers\>

åŸæ–‡ï¼š[https://lwn.net/Articles/847481/](https://lwn.net/Articles/847481/)

è¯‘æ–‡ï¼š[https://mp.weixin.qq.com/s?\_\_biz=Mzg2MjE0NDE5OA%3D%3D&chksm=ce0d142df97a9d3b38c65d66e757c606f0f8f17f9f6a0b037c68b6ddea7202e56587e0e08ebb&idx=1&mid=2247485316&scene=21&sn=82d4852102e3e63f63a16e8a7952289d\#wechat\_redirect](https://mp.weixin.qq.com/s?__biz=Mzg2MjE0NDE5OA%3D%3D&chksm=ce0d142df97a9d3b38c65d66e757c606f0f8f17f9f6a0b037c68b6ddea7202e56587e0e08ebb&idx=1&mid=2247485316&scene=21&sn=82d4852102e3e63f63a16e8a7952289d#wechat_redirect)

5ã€\<Lockless patterns: an introduction to compare\-and\-swap\>

åŸæ–‡ï¼š[https://lwn.net/Articles/847973/](https://lwn.net/Articles/847973/)

è¯‘æ–‡ï¼š[https://blog.csdn.net/Linux\_Everything/article/details/115315107?utm\_medium=distribute.pc\_relevant.none\-task\-blog\-2~default~baidujs\_title~default\-0\-115315107\-blog\-115018919.pc\_relevant\_antiscanv4&spm=1001.2101.3001.4242.1&utm\_relevant\_index=3](https://blog.csdn.net/Linux_Everything/article/details/115315107?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0-115315107-blog-115018919.pc_relevant_antiscanv4&spm=1001.2101.3001.4242.1&utm_relevant_index=3)

6ã€\<Lockless patterns: some final topics\>

åŸæ–‡ï¼š[https://lwn.net/Articles/850202/](https://lwn.net/Articles/850202/)

è¯‘æ–‡ï¼š[https://blog.csdn.net/Linux\_Everything/article/details/115774610?utm\_medium=distribute.pc\_relevant.none\-task\-blog\-2~default~baidujs\_title~default\-8\-115774610\-blog\-114609710.pc\_relevant\_antiscanv4&spm=1001.2101.3001.4242.5&utm\_relevant\_index=11](https://blog.csdn.net/Linux_Everything/article/details/115774610?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-8-115774610-blog-114609710.pc_relevant_antiscanv4&spm=1001.2101.3001.4242.5&utm_relevant_index=11)

7ã€\<Lockless patterns: more read\-modify\-write operations\>

åŸæ–‡ï¼š[https://lwn.net/Articles/849237/](https://lwn.net/Articles/849237/)

8ã€[https://www.cnblogs.com/gaochundong/p/lock\_free\_programming.html](https://www.cnblogs.com/gaochundong/p/lock_free_programming.html)

9ã€[https://www.cnblogs.com/caca/p/lock\-free\_CAS\_ABA.html](https://www.cnblogs.com/caca/p/lock-free_CAS_ABA.html)
