# è¿›ç¨‹ç®¡ç†ä¹‹ç”¨æˆ·æŠ¢å å’Œå†…æ ¸æŠ¢å 

`preempt`

[https://blog.csdn.net/gatieme/article/details/51872618](https://blog.csdn.net/gatieme/article/details/51872618)

[http://linuxperf.com/?p=211](http://linuxperf.com/?p=211)

**ä¸€ã€Â è¿›ç¨‹çŠ¶æ€**

ä¸€èˆ¬æ¥è¯´ï¼ŒCPUåœ¨ä»»ä½•æ—¶åˆ»éƒ½å¤„äºä»¥ä¸‹ä¸‰ç§æƒ…å†µä¹‹ä¸€ï¼š

- Â Â Â Â è¿è¡Œäºç”¨æˆ·ç©ºé—´ï¼Œæ‰§è¡Œç”¨æˆ·è¿›ç¨‹
- Â Â Â Â è¿è¡Œäºå†…æ ¸ç©ºé—´ï¼Œå¤„äºè¿›ç¨‹ä¸Šä¸‹æ–‡
- Â Â Â Â è¿è¡Œäºå†…æ ¸ç©ºé—´ï¼Œå¤„äºä¸­æ–­ä¸Šä¸‹æ–‡

**äºŒã€ç”¨æˆ·æŠ¢å** 

ä¸€èˆ¬æ¥è¯´, å½“è¿›ç¨‹ä»ç³»ç»Ÿè°ƒç”¨æˆ–è€…ä»ä¸­æ–­\(å¼‚å¸¸\)å¤„ç†ç¨‹åºè¿”å›ç”¨æˆ·ç©ºé—´æ—¶ä¼šè§¦å‘ä¸»è°ƒåº¦å™¨è¿›è¡Œç”¨æˆ·æŠ¢å 

- Â Â Â Â ä»ç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´
- Â Â Â Â ä»ä¸­æ–­\(å¼‚å¸¸\)å¤„ç†ç¨‹åºè¿”å›ç”¨æˆ·ç©ºé—´

ä¸ºäº†å¯¹ä¸€ä¸ªè¿›ç¨‹éœ€è¦è¢«è°ƒåº¦è¿›è¡Œæ ‡è®°, å†…æ ¸åœ¨thread\_infoçš„flagä¸­è®¾ç½®äº†ä¸€ä¸ªæ ‡è¯†æ¥æ ‡å¿—è¿›ç¨‹æ˜¯å¦éœ€è¦é‡æ–°è°ƒåº¦, å³é‡æ–°è°ƒåº¦need\_reschedæ ‡è¯†TIF\_NEED\_RESCHED, å†…æ ¸åœ¨å³å°†è¿”å›ç”¨æˆ·ç©ºé—´æ—¶ä¼šæ£€æŸ¥æ ‡è¯†TIF\_NEED\_RESCHEDæ ‡å¿—è¿›ç¨‹æ˜¯å¦éœ€è¦é‡æ–°è°ƒåº¦ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œå°±ä¼šå‘ç”Ÿè°ƒåº¦, è¿™è¢«ç§°ä¸ºç”¨æˆ·æŠ¢å ã€‚ï¼ˆTIF\_NEED\_RESCHEDæ ‡è¯†è¡¨ç¤ºè¿›ç¨‹æ˜¯å¦è¦è¢«æŠ¢å ï¼Œå¦‚æœç½®ä½äº†ï¼Œåˆ™åœ¨ç›¸åº”çš„æŠ¢å æ—¶é—´ç‚¹æŠ¢å ï¼‰

Â Â  Â é€šè¿‡thread\_infoä¸­çš„flagså­—æ®µæ ‡è¯†æ˜¯å¦ç”¨æˆ·æŠ¢å ã€‚

```
3466 static __always_inline bool need_resched(void)
3467 {
3468 â–¼Â Â Â return unlikely(tif_need_resched());Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
3469 }

#define tif_need_resched() test_thread_flag(TIF_NEED_RESCHED)

107 #define test_thread_flag(flag) \Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
108 â–¼Â Â Â test_ti_thread_flag(current_thread_info(), flag)

94 static inline int test_ti_thread_flag(struct thread_info *ti, int flag)
95 {
96 â–¼Â Â Â return test_bit(flag, (unsigned long *)&ti->flags);
97 }
```

arm32 ç”¨æˆ·æ€å‘ç”Ÿä¸­æ–­æ—¶ï¼Œè¿›è¡Œè¿›ç¨‹æŠ¢å çš„æ‰§è¡Œè¿‡ç¨‹ã€‚

irq\_usr \-ã€‹ ret\_to\_user\_from\_irq \-ã€‹Â slow\_work\_pending \-ã€‹Â do\_work\_pending \-ã€‹Â schedule

![8bdfc5e86cef8a34daf96b77560bac26.png](image/8bdfc5e86cef8a34daf96b77560bac26.png)

![347a85f7514d64500ed09ee208c01e9c.png](image/347a85f7514d64500ed09ee208c01e9c.png)

**ä¸‰ã€ å†…æ ¸æŠ¢å** 

å¦‚æœå†…æ ¸å¤„äºç›¸å¯¹è€—æ—¶çš„æ“ä½œä¸­, æ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿæˆ–è€…å†…å­˜ç®¡ç†ç›¸å…³çš„ä»»åŠ¡, è¿™ç§è¡Œä¸ºå¯èƒ½ä¼šå¸¦æ¥é—®é¢˜. è¿™ç§æƒ…å†µä¸‹, å†…æ ¸ä»£æ›¿ç‰¹å®šçš„è¿›ç¨‹æ‰§è¡Œç›¸å½“é•¿çš„æ—¶é—´, è€Œå…¶ä»–è¿›ç¨‹æ— æ³•æ‰§è¡Œ, æ— æ³•è°ƒåº¦, è¿™å°±é€ æˆäº†ç³»ç»Ÿçš„å»¶è¿Ÿå¢åŠ , ç”¨æˆ·ä½“éªŒåˆ°â€ç¼“æ…¢â€çš„å“åº”. å› æ­¤linuxå†…æ ¸å¼•å…¥äº†å†…æ ¸æŠ¢å .

linuxå†…æ ¸é€šè¿‡åœ¨thread\_infoç»“æ„ä¸­æ·»åŠ äº†ä¸€ä¸ªè‡ªæ—‹é”æ ‡è¯†preempt\_count, ç§°ä¸ºæŠ¢å è®¡æ•°å™¨\(preemption counter\)æ¥ä½œä¸ºå†…æ ¸æŠ¢å çš„æ ‡è®°,ï¼ˆè¿™ä¸ªæŠ¢å æ ‡è®°æ ‡è®°å½“å‰è¿›ç¨‹æ˜¯å¦å¯ä»¥è¢«æŠ¢å ï¼Œç›¸å½“äºæ˜¯å¦å¼€å¯å†…æ ¸æŠ¢å ï¼‰

```
12 /*
13Â Â * We put the hardirq and softirq counter into the preemption
14Â Â * counter. The bitmask has the following meaning:
15Â Â *
16Â Â * - bits 0-7 are the preemption count (max preemption depth: 256)
17Â Â * - bits 8-15 are the softirq count (max # of softirqs: 256)
18Â Â *
19Â Â * The hardirq count could in theory be the same as the number of
20Â Â * interrupts in the system, but we run all interrupt handlers with
21Â Â * interrupts disabled, so we cannot have nesting interrupts. Though
22Â Â * there are a few palaeontologic drivers which reenable interrupts in
23Â Â * the handler, so we need more than one bit here.
24Â Â *
25Â Â *Â Â Â Â Â Â Â Â Â PREEMPT_MASK:â–¼Â Â Â Â Â Â Â 0x000000ff
26Â Â *Â Â Â Â Â Â Â Â Â SOFTIRQ_MASK:â–¼Â Â Â Â Â Â Â 0x0000ff00
27Â Â *Â Â Â Â Â Â Â Â Â HARDIRQ_MASK:â–¼Â Â Â Â Â Â Â 0x000f0000
28Â Â *Â Â Â Â Â Â Â Â Â Â Â Â Â NMI_MASK:â–¼Â Â Â Â Â Â Â 0x00100000
29Â Â * PREEMPT_NEED_RESCHED:â–¼Â Â Â Â Â Â Â 0x80000000
30Â Â */
31 #define PREEMPT_BITSâ–¼Â Â Â 8
32 #define SOFTIRQ_BITSâ–¼Â Â Â 8
33 #define HARDIRQ_BITSâ–¼Â Â Â 4
34 #define NMI_BITSâ–¼Â Â Â Â Â Â Â 1
35
36 #define PREEMPT_SHIFTâ–¼Â Â 0
37 #define SOFTIRQ_SHIFTâ–¼Â Â (PREEMPT_SHIFT + PREEMPT_BITS)
38 #define HARDIRQ_SHIFTâ–¼Â Â (SOFTIRQ_SHIFT + SOFTIRQ_BITS)
39 #define NMI_SHIFTâ–¼Â Â Â Â Â Â (HARDIRQ_SHIFT + HARDIRQ_BITS)

48 #define PREEMPT_OFFSETâ–¼ (1UL << PREEMPT_SHIFT)
49 #define SOFTIRQ_OFFSETâ–¼ (1UL << SOFTIRQ_SHIFT)
50 #define HARDIRQ_OFFSETâ–¼ (1UL << HARDIRQ_SHIFT)
51 #define NMI_OFFSETâ–¼Â Â Â Â Â (1UL << NMI_SHIFT)
```

å†…æ ¸æŠ¢å çš„è§¦å‘å¤§è‡´ä¹Ÿæ˜¯ä¸¤ç±», å†…æ ¸æŠ¢å å…³é—­åé‡æ–°å¼€å¯æ—¶, ä¸­æ–­è¿”å›å†…æ ¸æ€æ—¶ã€‚

**Â  Â 1ã€ å†…æ ¸é‡æ–°å¼€å¯å†…æ ¸æŠ¢å æ—¶ä½¿ç”¨preempt\_scheduleæ£€æŸ¥å†…æ ¸æŠ¢å** 

preempt\_enable\-ã€‹\_\_preempt\_schedule\-ã€‹preempt\_schedule \-ã€‹Â preempt\_schedule\_common

è¿›ç¨‹è¿è¡Œpreempt\_scheduleï¼Œå¦‚æœè¿›ç¨‹thread\_infoÂ çš„flagså­—æ®µä¸­è®¾ç½®æ ‡è¯†TIF\_NEED\_RESCHEDï¼Œå°†è¿è¡Œè°ƒåº¦ç¨‹åºï¼Œè°ƒåº¦å‡ºå»ï¼Œè¯¥è¿›ç¨‹ç›¸åº”çš„æ ˆåº”è¯¥è¿è¡Œåˆ°è°ƒåº¦ç¨‹åºä¸­ï¼Œå¤„äºdoï¼Œwhileå¾ªç¯ä¸­ã€‚å¾…è¯¥è¿›ç¨‹å†æ¬¡è¢«è°ƒåº¦è¿›æ¥æ—¶ï¼Œå¾€ä¸‹è¿è¡Œå‡ºwhileå¾ªç¯ã€‚

å†…æ ¸ä»£ç ä¸­è¿™ç§é‡æ–°å¼€å¯å†…æ ¸æŠ¢å å¹¶è°ƒåº¦çš„åœºæ™¯åº”è¯¥ä¸å¤šï¼Œåªåœ¨locktorture.cæ–‡ä»¶ä¸­å­˜åœ¨å‡ å¤„ã€‚

![9d2ff00ee70162dd33d9362357822ec6.png](image/9d2ff00ee70162dd33d9362357822ec6.png)

**Â  Â 2ã€ ä¸­æ–­ä¹‹åè¿”å›å†…æ ¸æ€æ—¶é€šè¿‡preempt\_schedule\_irqè§¦å‘å†…æ ¸æŠ¢å** 

entry\-armv.S /share/linux\-4.9.94\_debug/arch/arm/kernel

ä»ä»£ç çœ‹ï¼Œåœ¨ä¸­æ–­é€€å‡ºå‡½æ•°ä¸­ï¼Œå¦‚æœæ­¤å‰è¢«ä¸­æ–­çš„æ˜¯å†…æ ¸æ€ï¼Œå¹¶ä¸”å®šä¹‰äº†CONFIG\_PREEMPTå†…æ ¸æŠ¢å å®ï¼Œæ­¤å¤„ä¼šè¿›å…¥å†…æ ¸æŠ¢å è°ƒåº¦

```
__irq_svc:

blneâ–¼Â Â Â svc_preempt

239 1:â–¼ blâ–¼ preempt_schedule_irqâ–¼Â Â Â â–¼Â Â Â @ irq en/disable is done inside

```

![e28fa06552bfacb7417abdc8902376c4.png](image/e28fa06552bfacb7417abdc8902376c4.png)
